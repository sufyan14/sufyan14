name: Dynamic GitHub Stats

on:
  schedule:
    - cron: "0 0 * * *" # Daily at midnight UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Update stats with progress bars
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const username = 'sufyan14';

            // 1ï¸âƒ£ Fetch all user repos
            const repos = await github.paginate(github.rest.repos.listForUser, { username, per_page: 100 });

            // 2ï¸âƒ£ Count commits authored by user
            let totalCommits = 0;
            for (const repo of repos) {
              try {
                const commits = await github.paginate(github.rest.repos.listCommits, {
                  owner: username,
                  repo: repo.name,
                  author: username,
                  per_page: 100
                });
                totalCommits += commits.length;
              } catch {}
            }

            // 3ï¸âƒ£ Count merged PRs authored by user
            let mergedPRs = 0;
            for (const repo of repos) {
              try {
                const prs = await github.paginate(github.rest.pulls.list, {
                  owner: username,
                  repo: repo.name,
                  state: 'closed',
                  per_page: 100
                });
                mergedPRs += prs.filter(pr => pr.merged_at && pr.user.login === username).length;
              } catch {}
            }

            // 4ï¸âƒ£ Calculate top languages
            const langMap = {};
            for (const repo of repos) {
              try {
                const langs = await github.rest.repos.listLanguages({ owner: username, repo: repo.name });
                for (const lang in langs.data) {
                  langMap[lang] = (langMap[lang] || 0) + langs.data[lang];
                }
              } catch {}
            }

            const sortedLangs = Object.entries(langMap)
              .sort((a,b) => b[1]-a[1])
              .slice(0,5); // top 5

            const totalBytes = sortedLangs.reduce((sum,[_,b]) => sum+b, 0);

            // 5ï¸âƒ£ Build dynamic progress bars
            const bars = sortedLangs.map(([lang, bytes]) => {
              const percent = totalBytes === 0 ? 0 : Math.round((bytes / totalBytes) * 100);
              const blocks = Math.round(percent / 10); // 10 blocks max
              let color;
              if (percent >= 60) color = 'ğŸŸ©';
              else if (percent >= 40) color = 'ğŸŸ¨';
              else color = 'ğŸŸ¥';
              const bar = color.repeat(blocks) + 'â¬œ'.repeat(10 - blocks);
              return `- ${lang.padEnd(10)}: ${bar} ${percent}%`;
            }).join('\n');

            // 6ï¸âƒ£ Contribution score
            const contributionScore = Math.min(100, Math.round(totalCommits / 5 + mergedPRs * 2 + repos.length));

            // 7ï¸âƒ£ Update README.md
            const fs = require('fs');
            let readme = fs.readFileSync('README.md', 'utf8');

            const statsText =
              `- ğŸ’» Total Commits: ${totalCommits}\n` +
              `- ğŸ· Repositories Contributed: ${repos.length}\n` +
              `- ğŸ” PRs Merged: ${mergedPRs}\n` +
              `- ğŸ“ˆ Contribution Score: ${contributionScore}/100\n` +
              `- ğŸ–¥ Top Languages:\n${bars}`;

            readme = readme.replace(
              /<!--START_SECTION:github_stats-->[\s\S]*<!--END_SECTION:github_stats-->/,
              `<!--START_SECTION:github_stats-->\n${statsText}\n<!--END_SECTION:github_stats-->`
            );

            fs.writeFileSync('README.md', readme);

      - name: Commit changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add README.md
          git commit -m "Update dynamic GitHub stats" || exit 0
          git push --force
