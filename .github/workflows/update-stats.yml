name: Dynamic GitHub Stats

on:
  schedule:
    - cron: "0 0 * * *" # Daily at midnight UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Update dynamic stats
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          node -e "
          const fs = require('fs');
          const { Octokit } = require('@octokit/rest');
          const octokit = new Octokit({ auth: process.env.GITHUB_TOKEN });
          const username = 'sufyan14';

          (async () => {
            // Fetch repos
            const repos = await octokit.paginate(octokit.repos.listForUser, { username, per_page: 100 });

            // Total commits
            let totalCommits = 0;
            for (const repo of repos) {
              try {
                const commits = await octokit.paginate(octokit.repos.listCommits, {
                  owner: username,
                  repo: repo.name,
                  author: username,
                  per_page: 100
                });
                totalCommits += commits.length;
              } catch {}

            }

            // Merged PRs
            let mergedPRs = 0;
            for (const repo of repos) {
              try {
                const prs = await octokit.paginate(octokit.pulls.list, {
                  owner: username,
                  repo: repo.name,
                  state: 'closed',
                  per_page: 100
                });
                mergedPRs += prs.filter(pr => pr.merged_at && pr.user.login === username).length;
              } catch {}
            }

            // Top languages
            const langMap = {};
            for (const repo of repos) {
              try {
                const langs = await octokit.repos.listLanguages({ owner: username, repo: repo.name });
                for (const lang in langs.data) {
                  langMap[lang] = (langMap[lang] || 0) + langs.data[lang];
                }
              } catch {}
            }
            const sortedLangs = Object.entries(langMap).sort((a,b) => b[1]-a[1]).slice(0,5);

            // Contribution score
            const contributionScore = Math.min(100, Math.round(totalCommits/5 + mergedPRs*2 + repos.length));

            // Update README
            let readme = fs.readFileSync('README.md', 'utf8');
            const statsText =
              '- üíª Total Commits: ' + totalCommits + '\\n' +
              '- üè∑ Repositories Contributed: ' + repos.length + '\\n' +
              '- üîÅ PRs Merged: ' + mergedPRs + '\\n' +
              '- üìà Contribution Score: ' + contributionScore + '/100';

            readme = readme.replace(
              /<!--START_SECTION:github_stats-->[\\s\\S]*<!--END_SECTION:github_stats-->/,
              '<!--START_SECTION:github_stats-->\\n' + statsText + '\\n<!--END_SECTION:github_stats-->'
            );

            // Build doughnut chart
            if (sortedLangs.length > 0) {
              const topLangs = sortedLangs.map(([lang]) => lang);
              const topBytes = sortedLangs.map(([_, bytes]) => bytes);

              const chartData = {
                type: 'doughnut',
                data: { labels: topLangs, datasets: [{ data: topBytes, backgroundColor: ['#f1e05a','#3572A5','#563d7c','#e34c26','#61dafb'] }] },
                options: {
                  plugins: {
                    legend: { display: true, position: 'bottom', labels: { fontSize: 10, usePointStyle: true, padding: 10 } },
                    title: { display: false },
                    datalabels: { display: false }
                  },
                  cutout: '50%'
                }
              };

              const chartURL = 'https://quickchart.io/chart?width=200&height=200&c=' + encodeURIComponent(JSON.stringify(chartData));
              readme = readme.replace(/!\[Top Languages\]\([^\)]*\)/, `![Top Languages](${chartURL})`);
            }

            fs.writeFileSync('README.md', readme);
          })();
          "

      - name: Commit changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add README.md
          git commit -m "Update dynamic GitHub stats" || exit 0
          git push --force
