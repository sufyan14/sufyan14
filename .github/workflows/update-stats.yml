name: Dynamic GitHub Stats

on:
  schedule:
    - cron: "0 0 * * *" # Daily at midnight UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Update dynamic stats
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const username = 'sufyan14';

            // 1Ô∏è‚É£ Fetch your repos
            const repos = await github.paginate(github.rest.repos.listForUser, { username, per_page: 100 });

            // 2Ô∏è‚É£ Count commits authored by you
            let totalCommits = 0;
            for (const repo of repos) {
              try {
                const commits = await github.paginate(github.rest.repos.listCommits, {
                  owner: username,
                  repo: repo.name,
                  author: username,
                  per_page: 100
                });
                totalCommits += commits.length;
              } catch (err) { }
            }

            // 3Ô∏è‚É£ Count merged PRs authored by you
            let mergedPRs = 0;
            for (const repo of repos) {
              try {
                const prs = await github.paginate(github.rest.pulls.list, {
                  owner: username,
                  repo: repo.name,
                  state: 'closed',
                  per_page: 100
                });
                mergedPRs += prs.filter(pr => pr.merged_at && pr.user.login === username).length;
              } catch (err) { }
            }

            // 4Ô∏è‚É£ Top languages across repos
            const langMap = {};
            for (const repo of repos) {
              try {
                const langs = await github.rest.repos.listLanguages({ owner: username, repo: repo.name });
                for (const lang in langs.data) {
                  if (!langMap[lang]) langMap[lang] = 0;
                  langMap[lang] += langs.data[lang];
                }
              } catch (err) { }
            }
            const sortedLangs = Object.entries(langMap).sort((a,b) => b[1]-a[1]).slice(0,5);

            // 5Ô∏è‚É£ Contribution Score
            const contributionScore = Math.min(100, Math.round(totalCommits/5 + mergedPRs*2 + repos.length));

            // 6Ô∏è‚É£ Build stats markdown
            const statsText =
              "- üíª Total Commits (authored by me): " + totalCommits + "\n" +
              "- üè∑ Repositories Contributed: " + repos.length + "\n" +
              "- üîÅ PRs Merged: " + mergedPRs + "\n" +
              "- üìà Contribution Score: " + contributionScore + "/100";

            let readme = fs.readFileSync('README.md', 'utf8');
            readme = readme.replace(
              /<!--START_SECTION:github_stats-->[\s\S]*<!--END_SECTION:github_stats-->/,
              "<!--START_SECTION:github_stats-->\n" + statsText + "\n<!--END_SECTION:github_stats-->"
            );

            // 7Ô∏è‚É£ Build doughnut chart URL for top languages
            if (sortedLangs.length > 0) {
              const topLangs = sortedLangs.map(([lang, bytes]) => lang);
              const topBytes = sortedLangs.map(([lang, bytes]) => bytes);
              const chartData = {
                type: 'doughnut',
                data: {
                  labels: topLangs,
                  datasets: [{
                    data: topBytes,
                    backgroundColor: ['#f1e05a','#3572A5','#563d7c','#e34c26','#61dafb']
                  }]
                },
                options: {
                  plugins: {
                    legend: { position: 'right' },
                    title: { display: true, text: 'Top Languages' }
                  }
                }
              };
              const chartURL = 'https://quickchart.io/chart?width=200&height=200&c=' + encodeURIComponent(JSON.stringify(chartData));
              readme = readme.replace(
                /!\[Top Languages\]\([^\)]*\)/,
                `![Top Languages](${chartURL})`
              );
            }

            fs.writeFileSync('README.md', readme);

      - name: Commit changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add README.md
          git commit -m "Update dynamic GitHub stats" || exit 0
          git push --force

